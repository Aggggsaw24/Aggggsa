name: Recovery Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-18.04
    
    steps:
    
      - uses: actions/checkout@v3
        
      - name: Cleanup
        uses: rokibhasansagar/slimhub_actions@main
      
      - name: Prepare the environment
        run: |
           sudo apt update
           sudo apt -y upgrade
           sudo apt -y install gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev libsdl1.2-dev libwxgtk3.0-dev libxml2 lzop pngcrush schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp qemu-user-static libstdc++-10-dev python
       
      - name: Install OpenJDK
        uses: actions/setup-java@v3
        with:
            distribution: 'zulu'
            java-version: '8'
            
      - name: Install repo
        run: |
            mkdir ~/bin
            curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
            chmod a+x ~/bin/repo
            sudo ln -sf ~/bin/repo /usr/bin/repo
            
      - name: Building recovery
        env:
           CONFIG: "config.sh"
           FOX_SYNC: https://gitlab.com/OrangeFox/sync.git
        run: |
           bash -c "$(curl -sL https://raw.githubusercontent.com/OrangeFoxRecovery/OrangeFox-CI/fox/scripts/checks.sh)"
           bash -c "$(curl -sL https://raw.githubusercontent.com/OrangeFoxRecovery/OrangeFox-CI/fox/scripts/sync.sh)"
           bash -c "$(curl -sL https://raw.githubusercontent.com/OrangeFoxRecovery/OrangeFox-CI/fox/scripts/build.sh)"
    
      - name: Upload to Release
        uses: softprops/action-gh-release@v0.1.14
        with:
          files: /home/runner/work/out/target/product/on5xelte/OrangeFox-R11.1-Stable-on5xelte.zip
          name: Image.gz-${{ github.run_id }}
          tag_name: ${{ github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
